const url = require('url');
const express = require('express');
const needle = require('needle');
const apicache = require('apicache');
const { stat } = require('fs');
const baseUrl = process.env.OPEN_AI_BASE_URL
const router = global.router;

// Root
router.get('/api/openai/', (req, res) => {
    res.status(200).json("This is the root of openai.  Please use an endpoint.")
})

router.post('/api/openai/tellme' , (req, res) => {
    try {
        const body = { model: "gpt-3.5-turbo", messages: [
                { role: "system", content: "you are a helpful assistant"},
                { role: "user", content: req.body.message},
            ]
        }
        const options = {
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${req.body.key}`}
        }
        console.log("posting request...")
        needle.post(baseUrl, body, options, (error, response, body) => {
            const status = response.statusCode || 500
            if(error) throw error
            res.status(status).json(body)
        })
       
    } catch (error) {
        console.log(`caught error ${error}`)
        res.status(500).json({ "error": error })
    }
})

router.post('/api/openai/showme' , (req, res) => {

})


module.exports = router;